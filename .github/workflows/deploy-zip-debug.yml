name: Deploy site.zip to GitHub Pages (debug fixed)

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show runner info
        run: |
          echo "USER: $(whoami)"
          echo "PWD: $(pwd)"
          echo "ROOT FILES:"
          ls -la

      - name: Ensure unzip is available
        run: |
          if ! command -v unzip >/dev/null 2>&1; then
            echo "Installing unzip..."
            sudo apt-get update -y
            sudo apt-get install -y unzip
          else
            echo "unzip present: $(which unzip)"
          fi

      - name: Confirm site.zip exists and list its contents
        run: |
          echo "Check current directory:"
          pwd
          ls -la
          if [ ! -f "./site.zip" ]; then
            echo "ERROR: site.zip not found at repo root."
            exit 2
          fi
          echo "site.zip contents:"
          unzip -l site.zip | sed -n '1,200p'

      - name: Extract and debug public/
        id: extract_debug
        run: |
          set -euo pipefail
          rm -rf public || true
          mkdir public
          echo "Extracting site.zip -> public/"
          unzip -oq site.zip -d public || { echo "unzip failed"; exit 3; }

          echo "Top-level entries under public/:"
          find public -mindepth 1 -maxdepth 1 -print -exec ls -la {} \; || true

          echo "Search for index.html under public/:"
          find public -type f -iname 'index.html' -print || true

          # If index.html exists at root, we are done
          if [ -f public/index.html ]; then
            echo "index.html found at public root."
            exit 0
          fi

          # If not at root, check if there is exactly one top-level directory we can flatten
          mapfile -t items < <(find public -mindepth 1 -maxdepth 1 -type d -print)
          count=${#items[@]}
          echo "Top-level directory count: $count"
          if [ "$count" -eq 1 ]; then
            src="${items[0]}"
            echo "Flattening contents of $src into public/"
            # Move non-hidden
            mv "$src"/* public/ 2>/dev/null || true
            # Move hidden (dot) files if present
            mv "$src"/.[!.]* public/ 2>/dev/null || true || true
            rmdir "$src" 2>/dev/null || true
            echo "After flattening, listing public/:"
            ls -la public | sed -n '1,200p'
            if [ ! -f public/index.html ]; then
              echo "ERROR: index.html still not found after flattening."
              find public -maxdepth 4 -print
              exit 4
            fi
          else
            echo "Cannot auto-flatten (zero or multiple top-level directories). Showing tree:"
            find public -maxdepth 4 -print
            if [ ! -f public/index.html ]; then
              echo "ERROR: No index.html at public root and cannot auto-flatten."
              exit 5
            fi
          fi

      - name: (Optional) write CNAME from secret
        if: ${{ secrets.CUSTOM_DOMAIN != '' }}
        run: |
          echo "Writing CNAME from secret..."
          echo "${{ secrets.CUSTOM_DOMAIN }}" > public/CNAME || true
          ls -la public | sed -n '1,200p'

      - name: Final public check
        run: |
          echo "Final public top-level:"
          ls -la public | sed -n '1,200p'
          if [ -f public/index.html ]; then
            echo "OK: index.html present"
          else
            echo "MISSING index.html; aborting"
            exit 6
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
