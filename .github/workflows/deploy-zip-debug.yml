name: Deploy site.zip to GitHub Pages (no secrets)

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check system info
        run: |
          echo "Runner: $(uname -a)"
          echo "Current directory: $(pwd)"
          ls -la

      - name: Ensure unzip is installed
        run: |
          if ! command -v unzip >/dev/null 2>&1; then
            echo "Installing unzip..."
            sudo apt-get update -y
            sudo apt-get install -y unzip
          else
            echo "unzip already installed"
          fi

      - name: Verify site.zip presence
        run: |
          if [ ! -f "./site.zip" ]; then
            echo "❌ site.zip not found at repo root."
            exit 1
          fi
          echo "✅ site.zip found."
          unzip -l site.zip | head -n 20

      - name: Extract site.zip to public
        run: |
          rm -rf public || true
          mkdir public
          unzip -oq site.zip -d public

          echo "Contents of public/:"
          find public -maxdepth 2 -print

          # Handle nested folder (common zip issue)
          if [ ! -f public/index.html ]; then
            inner_dir=$(find public -mindepth 1 -maxdepth 1 -type d | head -n 1)
            if [ -n "$inner_dir" ]; then
              echo "Flattening nested folder: $inner_dir"
              mv "$inner_dir"/* public/ 2>/dev/null || true
              mv "$inner_dir"/.[!.]* public/ 2>/dev/null || true
              rmdir "$inner_dir" 2>/dev/null || true
            fi
          fi

          if [ ! -f public/index.html ]; then
            echo "❌ index.html not found after extraction."
            find public -maxdepth 3 -print
            exit 2
          fi

          echo "✅ index.html found in public/"

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
